#!/bin/bash

RANK=$(flux getattr rank)
exit_rc=0

# Usage: modrm {all|<rank>} modname
modrm() {
    local where=$1; shift
    if test "$where" = "all" || test $where -eq $RANK; then
        flux module remove -f $* || exit_rc=1
    fi
}

core_dir=$(cd ${0%/*} && pwd -P)
all_dirs=$core_dir${FLUX_RC_EXTRA:+":$FLUX_RC_EXTRA"}
IFS=:
shopt -s nullglob
for rcdir in $all_dirs; do
    for rcfile in $rcdir/rc3.d/*; do
        echo running $rcfile
        $rcfile || exit_rc=1
    done
done
shopt -u nullglob

modrm 0 heartbeat
modrm 0 sched-simple
modrm all resource
modrm 0 job-archive
modrm 0 job-exec
modrm 0 job-db
modrm all job-info
modrm 0 job-manager
modrm all job-ingest

modrm 0 cron
modrm all barrier

if test $RANK -eq 0; then
    flux startlog --post-finish-event || exit_rc=1
fi

modrm all kvs-watch
modrm all kvs

flux content flush || exit_rc=1

backingmod=$(flux getattr content.backing-module 2>/dev/null)
modrm 0 ${backingmod:-content-sqlite}

exit $exit_rc
